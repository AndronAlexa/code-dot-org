#!/usr/bin/env ruby
require 'cdo/chat_client'
require_relative 'only_one'
abort 'Script already running' unless only_one_running?(__FILE__)

require_relative '../../dashboard/config/environment'

# We want to avoid storing student chat messages any longer than
# is necessary for analysis to prevent storing excess student PII. This deletes
# any AichatEvent or AichatRequest older than 90 days.
# 
# Additionally, we delete any AichatSession older than 30 days. AichatSession is
# no longer in use and we plan to fully delete the table.
# See https://codedotorg.atlassian.net/browse/LABS-976 for details.
#
# Log the number of records deleted for each table to Slack, #cron-watcher-aichat-deletion
# so we can easily monitor the deletion process.
def main
  thirty_days_ago = Time.now - 30.days
  ninety_days_ago = Time.now - 90.days

  destroyed_sessions = AichatSession.where('created_at < ?', thirty_days_ago).destroy_all
  ChatClient.message('cron-watcher-aichat-deletion', "Deleted #{destroyed_sessions.length} AichatSession records")
 
  destroyed_events = AichatEvent.where('created_at < ?', ninety_days_ago).destroy_all
  ChatClient.message('cron-watcher-aichat-deletion', "Deleted #{destroyed_events.length} AichatEvent records")
  
  destroyed_requests = AichatRequest.where('created_at < ?', ninety_days_ago).destroy_all
  ChatClient.message('cron-watcher-aichat-deletion', "Deleted #{destroyed_requests.length} AichatRequest records")
end

main